"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
const _1 = require(".");
const future_1 = require("./utils/future");
exports.defer = Promise.resolve().then.bind(Promise.resolve());
/** Managed queue of dirty components to be re-rendered */
let items = [];
function enqueueRender(scene) {
    if (!scene._dirty) {
        scene._dirty = true;
        if (items.push(scene) === 1) {
            exports.defer(rerender);
        }
    }
}
function rerender() {
    let p;
    const list = items;
    items = [];
    // tslint:disable-next-line:no-conditional-assignment
    while ((p = list.pop())) {
        if (p._dirty)
            renderScriptableScene(p);
    }
}
function filterNonFalsy($) {
    return !!$;
}
function recursiveRender(tree) {
    if (typeof tree === 'string') {
        // tslint:disable-next-line:no-console
        console.error('Warning, you are trying to render a text');
        return null;
    }
    if (typeof tree.tag === 'function') {
        const hoc = tree.tag;
        if (hoc.prototype && hoc.prototype.render) {
            throw new Error('Only function components are allowed');
        }
        return hoc(Object.assign({}, tree.attrs, { children: tree.children }));
    }
    if (!tree || !tree.tag)
        return null;
    return {
        tag: tree.tag,
        attrs: tree.attrs,
        children: tree.children.map(recursiveRender).filter(filterNonFalsy)
    };
}
exports.recursiveRender = recursiveRender;
/**
 * Render a ScriptableScene, triggering necessary lifecycle events and taking High-Order ScriptableScenes into account.
 * @param {ScriptableScene} scene
 * @internal
 */
function renderScriptableScene(scene, force) {
    let props = scene.props;
    let state = scene.state;
    let previousProps = scene.prevProps || props;
    let previousState = scene.prevState || state;
    let skip = false;
    const isUpdate = !!scene._component;
    // if updating
    if (isUpdate) {
        scene.props = previousProps;
        scene.state = previousState;
        if (!force && scene.shouldSceneUpdate && scene.shouldSceneUpdate(props, state) === false) {
            skip = true;
        }
        scene.props = props;
        scene.state = state;
    }
    scene.prevProps = scene.prevState = null;
    scene._dirty = false;
    if (!skip) {
        let rendererResult = scene.render(props, state);
        if (!('then' in rendererResult && 'catch' in rendererResult)) {
            rendererResult = Promise.resolve(rendererResult);
        }
        rendererResult
            .then(recursiveRender)
            .then(async (rendered) => {
            if (!rendered) {
                throw new Error('the async render() method yielded an empty result');
            }
            scene._component = rendered;
            if (scene.sceneDidUpdate) {
                await scene.sceneDidUpdate(previousProps, previousState);
            }
            await scene.connectionFuture;
            try {
                // TODO(agus): diff/patch
                await scene.entityController.render(rendered);
            }
            catch (e) {
                if (e.message === _1.Constants.ReplaceWholeTreeException) {
                    await scene.entityController.render(rendered);
                }
                else {
                    throw e;
                }
            }
        })
            .catch(err => {
            // tslint:disable-next-line:no-console
            console.error(err);
        });
    }
}
exports.renderScriptableScene = renderScriptableScene;
/**
 * Base Scene class.
 * Provides `setState()` and `forceUpdate()`, which trigger rendering.
 * @public
 *
 * @example
 * class MyFoo extends ScriptableScene {
 *   async render() {
 *     return <sphere />;
 *   }
 * }
 */
class ScriptableScene extends _1.Script {
    constructor() {
        super(...arguments);
        // @internal
        this._dirty = true;
        // @internal
        this.prevProps = null;
        // @internal
        this.prevState = null;
        // @internal
        this._component = null;
        this.state = {};
        // @internal
        this.connectionFuture = future_1.future();
    }
    /**
     * Update scene state by copying properties from `state` to `this.state`.
     * @param {object} state A hash of state properties to update with new values
     */
    setState(state) {
        let s = this.state;
        if (!this.prevState)
            this.prevState = Object.assign({}, s);
        Object.assign(s, typeof state === 'function' ? state(s, this.props) : state);
        enqueueRender(this);
    }
    /**
     * Immediately perform a synchronous re-render of the component.
     */
    forceUpdate() {
        renderScriptableScene(this, true);
    }
    /**
     * It makes a subscription to remote events, those events occur in the context of the game and are sent thru the wire
     * protocol.
     *
     * @param event name of the remote event to listen
     * @param handler an async
     */
    subscribeTo(event, handler) {
        // tslint:disable-next-line:no-floating-promises
        this.connectionFuture.then(() => {
            this.eventSubscriber.on(event, x => {
                const ret = handler(x.data);
                if (ret && 'catch' in ret && typeof ret.catch === 'function') {
                    ret.catch(err => this.emit('error', err));
                }
            });
        });
    }
    /**
     * Get a standard ethereum provider
     * Please notice this is highly experimental and might change in the future.
     *
     * method whitelist = [
     *   'eth_sendTransaction',
     *   'eth_getTransactionReceipt',
     *   'eth_estimateGas',
     *   'eth_call',
     *   'eth_getBalance',
     *   'eth_getStorageAt',
     *   'eth_blockNumber',
     *   'eth_getBlockByNumber',
     *   'eth_gasPrice',
     *   'eth_protocolVersion',
     *   'net_version',
     *   'web3_sha3',
     *   'web3_clientVersion',
     *   'eth_getTransactionCount'
     * ]
     */
    async getEthereumProvider() {
        const { experimentalEthereumController } = await this.loadAPIs(['experimentalEthereumController']);
        return {
            // @internal
            send() {
                throw new Error('Decentraland provider only allows async calls');
            },
            sendAsync(message, callback) {
                experimentalEthereumController
                    .sendAsync(message)
                    .then((x) => callback(null, x))
                    .catch(callback);
            }
        };
    }
    // @internal
    async systemDidEnable() {
        this.props = (await this.entityController.getOwnAttributes());
        // we create an event subscriber
        this.eventSubscriber = new _1.EventSubscriber(this.entityController);
        this.on('SIGKILL', () => {
            if (this.sceneWillUnmount) {
                this.sceneWillUnmount();
            }
        });
        this.subscribeTo('setAttributes', newProps => {
            this.prevProps = this.props;
            this.props = newProps;
            enqueueRender(this);
        });
        this.connectionFuture.resolve(this);
        renderScriptableScene(this, true);
        if (this.sceneDidMount) {
            await this.sceneDidMount();
        }
    }
}
__decorate([
    _1.inject('EntityController'),
    __metadata("design:type", Object)
], ScriptableScene.prototype, "entityController", void 0);
exports.ScriptableScene = ScriptableScene;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NyaXB0YWJsZVNjZW5lLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1NjcmlwdGFibGVTY2VuZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLHdCQVVVO0FBRVYsMkNBQXVDO0FBRTFCLFFBQUEsS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFBO0FBRW5FLDBEQUEwRDtBQUUxRCxJQUFJLEtBQUssR0FBZ0MsRUFBRSxDQUFBO0FBRTNDLHVCQUE2QixLQUE0QjtJQUN2RCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRTtRQUNqQixLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQTtRQUNuQixJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzNCLGFBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQTtTQUNoQjtLQUNGO0FBQ0gsQ0FBQztBQUVEO0lBQ0UsSUFBSSxDQUE4QixDQUFBO0lBQ2xDLE1BQU0sSUFBSSxHQUFzQixLQUFLLENBQUE7SUFDckMsS0FBSyxHQUFHLEVBQUUsQ0FBQTtJQUNWLHFEQUFxRDtJQUNyRCxPQUFPLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFO1FBQ3ZCLElBQUksQ0FBQyxDQUFDLE1BQU07WUFBRSxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUN2QztBQUNILENBQUM7QUFFRCx3QkFBd0IsQ0FBTTtJQUM1QixPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFDWixDQUFDO0FBRUQseUJBQWdDLElBQXFCO0lBQ25ELElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1FBQzVCLHNDQUFzQztRQUN0QyxPQUFPLENBQUMsS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUE7UUFDekQsT0FBTyxJQUFJLENBQUE7S0FDWjtJQUVELElBQUksT0FBUSxJQUFJLENBQUMsR0FBVyxLQUFLLFVBQVUsRUFBRTtRQUMzQyxNQUFNLEdBQUcsR0FBSSxJQUFJLENBQUMsR0FBdUIsQ0FBQTtRQUN6QyxJQUFJLEdBQUcsQ0FBQyxTQUFTLElBQUksR0FBRyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7WUFDekMsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFBO1NBQ3hEO1FBQ0QsT0FBTyxHQUFHLG1CQUFNLElBQUksQ0FBQyxLQUFLLElBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLElBQUcsQ0FBQTtLQUN2RDtJQUVELElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRztRQUFFLE9BQU8sSUFBSSxDQUFBO0lBRW5DLE9BQU87UUFDTCxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUc7UUFDYixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7UUFDakIsUUFBUSxFQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQThCO0tBQ2xHLENBQUE7QUFDSCxDQUFDO0FBdEJELDBDQXNCQztBQUVEOzs7O0dBSUc7QUFDSCwrQkFBb0QsS0FBb0MsRUFBRSxLQUFlO0lBQ3ZHLElBQUksS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUE7SUFDdkIsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQTtJQUN2QixJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQTtJQUM1QyxJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQTtJQUM1QyxJQUFJLElBQUksR0FBRyxLQUFLLENBQUE7SUFDaEIsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUE7SUFFbkMsY0FBYztJQUNkLElBQUksUUFBUSxFQUFFO1FBQ1osS0FBSyxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUE7UUFDM0IsS0FBSyxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUE7UUFDM0IsSUFBSSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsaUJBQWlCLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxLQUFLLEVBQUU7WUFDeEYsSUFBSSxHQUFHLElBQUksQ0FBQTtTQUNaO1FBQ0QsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7UUFDbkIsS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUE7S0FDcEI7SUFFRCxLQUFLLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFBO0lBQ3hDLEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFBO0lBRXBCLElBQUksQ0FBQyxJQUFJLEVBQUU7UUFDVCxJQUFJLGNBQWMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUUvQyxJQUFJLENBQUMsQ0FBQyxNQUFNLElBQUksY0FBYyxJQUFJLE9BQU8sSUFBSSxjQUFjLENBQUMsRUFBRTtZQUM1RCxjQUFjLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQTtTQUNqRDtRQUVELGNBQWM7YUFDWCxJQUFJLENBQUMsZUFBZSxDQUFDO2FBQ3JCLElBQUksQ0FBQyxLQUFLLEVBQUMsUUFBUSxFQUFDLEVBQUU7WUFDckIsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDYixNQUFNLElBQUksS0FBSyxDQUFDLG1EQUFtRCxDQUFDLENBQUE7YUFDckU7WUFFRCxLQUFLLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQTtZQUUzQixJQUFJLEtBQUssQ0FBQyxjQUFjLEVBQUU7Z0JBQ3hCLE1BQU0sS0FBSyxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsYUFBYSxDQUFDLENBQUE7YUFDekQ7WUFFRCxNQUFNLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQTtZQUU1QixJQUFJO2dCQUNGLHlCQUF5QjtnQkFDekIsTUFBTSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO2FBQzlDO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1YsSUFBSSxDQUFDLENBQUMsT0FBTyxLQUFLLFlBQVMsQ0FBQyx5QkFBeUIsRUFBRTtvQkFDckQsTUFBTSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO2lCQUM5QztxQkFBTTtvQkFDTCxNQUFNLENBQUMsQ0FBQTtpQkFDUjthQUNGO1FBQ0gsQ0FBQyxDQUFDO2FBQ0QsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ1gsc0NBQXNDO1lBQ3RDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDcEIsQ0FBQyxDQUFDLENBQUE7S0FDTDtBQUNILENBQUM7QUE1REQsc0RBNERDO0FBOEJEOzs7Ozs7Ozs7OztHQVdHO0FBQ0gscUJBQThELFNBQVEsU0FBTTtJQUE1RTs7UUFNRSxZQUFZO1FBQ1osV0FBTSxHQUFHLElBQUksQ0FBQTtRQUNiLFlBQVk7UUFDWixjQUFTLEdBQWlCLElBQUksQ0FBQTtRQUM5QixZQUFZO1FBQ1osY0FBUyxHQUFpQixJQUFJLENBQUE7UUFDOUIsWUFBWTtRQUNaLGVBQVUsR0FBMkIsSUFBSSxDQUFBO1FBRXpDLFVBQUssR0FBVSxFQUFXLENBQUE7UUFFMUIsWUFBWTtRQUNaLHFCQUFnQixHQUFHLGVBQU0sRUFBVSxDQUFBO0lBa0hyQyxDQUFDO0lBOUdDOzs7T0FHRztJQUNILFFBQVEsQ0FBQyxLQUF3RTtRQUMvRSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFBO1FBQ2xCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUztZQUFFLElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDMUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsT0FBTyxLQUFLLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDNUUsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3JCLENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVc7UUFDVCxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDbkMsQ0FBQztJQVVEOzs7Ozs7T0FNRztJQUNILFdBQVcsQ0FBd0IsS0FBUSxFQUFFLE9BQW1EO1FBQzlGLGdEQUFnRDtRQUNoRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUM5QixJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2pDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUE7Z0JBQzNCLElBQUksR0FBRyxJQUFJLE9BQU8sSUFBSSxHQUFHLElBQUksT0FBTyxHQUFHLENBQUMsS0FBSyxLQUFLLFVBQVUsRUFBRTtvQkFDNUQsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUE7aUJBQzFDO1lBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDSixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7T0FvQkc7SUFDSCxLQUFLLENBQUMsbUJBQW1CO1FBQ3ZCLE1BQU0sRUFBRSw4QkFBOEIsRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLGdDQUFnQyxDQUFDLENBQUMsQ0FBQTtRQUVsRyxPQUFPO1lBQ0wsWUFBWTtZQUNaLElBQUk7Z0JBQ0YsTUFBTSxJQUFJLEtBQUssQ0FBQywrQ0FBK0MsQ0FBQyxDQUFBO1lBQ2xFLENBQUM7WUFDRCxTQUFTLENBQUMsT0FBMkIsRUFBRSxRQUFxRDtnQkFDMUYsOEJBQThCO3FCQUMzQixTQUFTLENBQUMsT0FBTyxDQUFDO3FCQUNsQixJQUFJLENBQUMsQ0FBQyxDQUFNLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7cUJBQ25DLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQTtZQUNwQixDQUFDO1NBQ0YsQ0FBQTtJQUNILENBQUM7SUFFRCxZQUFZO0lBQ1osS0FBSyxDQUFDLGVBQWU7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixFQUFFLENBQVUsQ0FBQTtRQUV0RSxnQ0FBZ0M7UUFDaEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLGtCQUFlLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUE7UUFFakUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsR0FBRyxFQUFFO1lBQ3RCLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO2dCQUN6QixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQTthQUN4QjtRQUNILENBQUMsQ0FBQyxDQUFBO1FBRUYsSUFBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLEVBQUUsUUFBUSxDQUFDLEVBQUU7WUFDM0MsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFBO1lBQzNCLElBQUksQ0FBQyxLQUFLLEdBQUcsUUFBaUIsQ0FBQTtZQUM5QixhQUFhLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDckIsQ0FBQyxDQUFDLENBQUE7UUFFRixJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBRW5DLHFCQUFxQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUVqQyxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdEIsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUE7U0FDM0I7SUFDSCxDQUFDO0NBQ0Y7QUFsSTZCO0lBQTNCLFNBQU0sQ0FBQyxrQkFBa0IsQ0FBQzs7eURBQW9DO0FBRmpFLDBDQW9JQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFNjcmlwdCxcbiAgaW5qZWN0LFxuICBFbnRpdHlDb250cm9sbGVyLFxuICBJU2ltcGxpZmllZE5vZGUsXG4gIEV2ZW50U3Vic2NyaWJlcixcbiAgQ29uc3RhbnRzLFxuICBJRXZlbnROYW1lcyxcbiAgSUV2ZW50cyxcbiAgUlBDU2VuZGFibGVNZXNzYWdlXG59IGZyb20gJy4nXG5cbmltcG9ydCB7IGZ1dHVyZSB9IGZyb20gJy4vdXRpbHMvZnV0dXJlJ1xuXG5leHBvcnQgY29uc3QgZGVmZXIgPSBQcm9taXNlLnJlc29sdmUoKS50aGVuLmJpbmQoUHJvbWlzZS5yZXNvbHZlKCkpXG5cbi8qKiBNYW5hZ2VkIHF1ZXVlIG9mIGRpcnR5IGNvbXBvbmVudHMgdG8gYmUgcmUtcmVuZGVyZWQgKi9cblxubGV0IGl0ZW1zOiBTY3JpcHRhYmxlU2NlbmU8YW55LCBhbnk+W10gPSBbXVxuXG5mdW5jdGlvbiBlbnF1ZXVlUmVuZGVyPEQsIFQ+KHNjZW5lOiBTY3JpcHRhYmxlU2NlbmU8RCwgVD4pIHtcbiAgaWYgKCFzY2VuZS5fZGlydHkpIHtcbiAgICBzY2VuZS5fZGlydHkgPSB0cnVlXG4gICAgaWYgKGl0ZW1zLnB1c2goc2NlbmUpID09PSAxKSB7XG4gICAgICBkZWZlcihyZXJlbmRlcilcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVyZW5kZXIoKSB7XG4gIGxldCBwOiBTY3JpcHRhYmxlU2NlbmUgfCB1bmRlZmluZWRcbiAgY29uc3QgbGlzdDogU2NyaXB0YWJsZVNjZW5lW10gPSBpdGVtc1xuICBpdGVtcyA9IFtdXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25kaXRpb25hbC1hc3NpZ25tZW50XG4gIHdoaWxlICgocCA9IGxpc3QucG9wKCkpKSB7XG4gICAgaWYgKHAuX2RpcnR5KSByZW5kZXJTY3JpcHRhYmxlU2NlbmUocClcbiAgfVxufVxuXG5mdW5jdGlvbiBmaWx0ZXJOb25GYWxzeSgkOiBhbnkpOiAkIGlzIHRydWUge1xuICByZXR1cm4gISEkXG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZWN1cnNpdmVSZW5kZXIodHJlZTogSVNpbXBsaWZpZWROb2RlKTogSVNpbXBsaWZpZWROb2RlIHwgbnVsbCB7XG4gIGlmICh0eXBlb2YgdHJlZSA9PT0gJ3N0cmluZycpIHtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxuICAgIGNvbnNvbGUuZXJyb3IoJ1dhcm5pbmcsIHlvdSBhcmUgdHJ5aW5nIHRvIHJlbmRlciBhIHRleHQnKVxuICAgIHJldHVybiBudWxsXG4gIH1cblxuICBpZiAodHlwZW9mICh0cmVlLnRhZyBhcyBhbnkpID09PSAnZnVuY3Rpb24nKSB7XG4gICAgY29uc3QgaG9jID0gKHRyZWUudGFnIGFzIGFueSkgYXMgRnVuY3Rpb25cbiAgICBpZiAoaG9jLnByb3RvdHlwZSAmJiBob2MucHJvdG90eXBlLnJlbmRlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdPbmx5IGZ1bmN0aW9uIGNvbXBvbmVudHMgYXJlIGFsbG93ZWQnKVxuICAgIH1cbiAgICByZXR1cm4gaG9jKHsgLi4udHJlZS5hdHRycywgY2hpbGRyZW46IHRyZWUuY2hpbGRyZW4gfSlcbiAgfVxuXG4gIGlmICghdHJlZSB8fCAhdHJlZS50YWcpIHJldHVybiBudWxsXG5cbiAgcmV0dXJuIHtcbiAgICB0YWc6IHRyZWUudGFnLFxuICAgIGF0dHJzOiB0cmVlLmF0dHJzLFxuICAgIGNoaWxkcmVuOiAodHJlZS5jaGlsZHJlbi5tYXAocmVjdXJzaXZlUmVuZGVyKS5maWx0ZXIoZmlsdGVyTm9uRmFsc3kpIGFzIGFueSkgYXMgSVNpbXBsaWZpZWROb2RlW11cbiAgfVxufVxuXG4vKipcbiAqIFJlbmRlciBhIFNjcmlwdGFibGVTY2VuZSwgdHJpZ2dlcmluZyBuZWNlc3NhcnkgbGlmZWN5Y2xlIGV2ZW50cyBhbmQgdGFraW5nIEhpZ2gtT3JkZXIgU2NyaXB0YWJsZVNjZW5lcyBpbnRvIGFjY291bnQuXG4gKiBAcGFyYW0ge1NjcmlwdGFibGVTY2VuZX0gc2NlbmVcbiAqIEBpbnRlcm5hbFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyU2NyaXB0YWJsZVNjZW5lPFByb3BzLCBTdGF0ZT4oc2NlbmU6IFNjcmlwdGFibGVTY2VuZTxQcm9wcywgU3RhdGU+LCBmb3JjZT86IGJvb2xlYW4pIHtcbiAgbGV0IHByb3BzID0gc2NlbmUucHJvcHNcbiAgbGV0IHN0YXRlID0gc2NlbmUuc3RhdGVcbiAgbGV0IHByZXZpb3VzUHJvcHMgPSBzY2VuZS5wcmV2UHJvcHMgfHwgcHJvcHNcbiAgbGV0IHByZXZpb3VzU3RhdGUgPSBzY2VuZS5wcmV2U3RhdGUgfHwgc3RhdGVcbiAgbGV0IHNraXAgPSBmYWxzZVxuICBjb25zdCBpc1VwZGF0ZSA9ICEhc2NlbmUuX2NvbXBvbmVudFxuXG4gIC8vIGlmIHVwZGF0aW5nXG4gIGlmIChpc1VwZGF0ZSkge1xuICAgIHNjZW5lLnByb3BzID0gcHJldmlvdXNQcm9wc1xuICAgIHNjZW5lLnN0YXRlID0gcHJldmlvdXNTdGF0ZVxuICAgIGlmICghZm9yY2UgJiYgc2NlbmUuc2hvdWxkU2NlbmVVcGRhdGUgJiYgc2NlbmUuc2hvdWxkU2NlbmVVcGRhdGUocHJvcHMsIHN0YXRlKSA9PT0gZmFsc2UpIHtcbiAgICAgIHNraXAgPSB0cnVlXG4gICAgfVxuICAgIHNjZW5lLnByb3BzID0gcHJvcHNcbiAgICBzY2VuZS5zdGF0ZSA9IHN0YXRlXG4gIH1cblxuICBzY2VuZS5wcmV2UHJvcHMgPSBzY2VuZS5wcmV2U3RhdGUgPSBudWxsXG4gIHNjZW5lLl9kaXJ0eSA9IGZhbHNlXG5cbiAgaWYgKCFza2lwKSB7XG4gICAgbGV0IHJlbmRlcmVyUmVzdWx0ID0gc2NlbmUucmVuZGVyKHByb3BzLCBzdGF0ZSlcblxuICAgIGlmICghKCd0aGVuJyBpbiByZW5kZXJlclJlc3VsdCAmJiAnY2F0Y2gnIGluIHJlbmRlcmVyUmVzdWx0KSkge1xuICAgICAgcmVuZGVyZXJSZXN1bHQgPSBQcm9taXNlLnJlc29sdmUocmVuZGVyZXJSZXN1bHQpXG4gICAgfVxuXG4gICAgcmVuZGVyZXJSZXN1bHRcbiAgICAgIC50aGVuKHJlY3Vyc2l2ZVJlbmRlcilcbiAgICAgIC50aGVuKGFzeW5jIHJlbmRlcmVkID0+IHtcbiAgICAgICAgaWYgKCFyZW5kZXJlZCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcigndGhlIGFzeW5jIHJlbmRlcigpIG1ldGhvZCB5aWVsZGVkIGFuIGVtcHR5IHJlc3VsdCcpXG4gICAgICAgIH1cblxuICAgICAgICBzY2VuZS5fY29tcG9uZW50ID0gcmVuZGVyZWRcblxuICAgICAgICBpZiAoc2NlbmUuc2NlbmVEaWRVcGRhdGUpIHtcbiAgICAgICAgICBhd2FpdCBzY2VuZS5zY2VuZURpZFVwZGF0ZShwcmV2aW91c1Byb3BzLCBwcmV2aW91c1N0YXRlKVxuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgc2NlbmUuY29ubmVjdGlvbkZ1dHVyZVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gVE9ETyhhZ3VzKTogZGlmZi9wYXRjaFxuICAgICAgICAgIGF3YWl0IHNjZW5lLmVudGl0eUNvbnRyb2xsZXIucmVuZGVyKHJlbmRlcmVkKVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgaWYgKGUubWVzc2FnZSA9PT0gQ29uc3RhbnRzLlJlcGxhY2VXaG9sZVRyZWVFeGNlcHRpb24pIHtcbiAgICAgICAgICAgIGF3YWl0IHNjZW5lLmVudGl0eUNvbnRyb2xsZXIucmVuZGVyKHJlbmRlcmVkKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBlXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKVxuICAgICAgfSlcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNjcmlwdGFibGVTY2VuZTxQcm9wcywgU3RhdGU+IHtcbiAgcHJvcHM6IFByb3BzXG4gIHN0YXRlOiBTdGF0ZVxuXG4gIC8qKlxuICAgKiBDYWxsZWQgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgdGhlIGNoYW5nZSBpbiBwcm9wcyBhbmQgc3RhdGUgc2hvdWxkIHRyaWdnZXIgYSByZS1yZW5kZXIuXG4gICAqXG4gICAqIElmIGZhbHNlIGlzIHJldHVybmVkLCBgU2NyaXB0YWJsZVNjZW5lI3JlbmRlcmAsIGFuZCBgc2NlbmVEaWRVcGRhdGVgIHdpbGwgbm90IGJlIGNhbGxlZC5cbiAgICovXG4gIHNob3VsZFNjZW5lVXBkYXRlPyhuZXh0UHJvcHM6IFByb3BzLCBuZXh0U3RhdGU6IFN0YXRlKTogUHJvbWlzZTxib29sZWFuPiB8IGJvb2xlYW5cblxuICAvKipcbiAgICogQ2FsbGVkIGltbWVkaWF0ZWx5IGJlZm9yZSBhIHNjZW5lIGlzIGRlc3Ryb3llZC4gUGVyZm9ybSBhbnkgbmVjZXNzYXJ5IGNsZWFudXAgaW4gdGhpcyBtZXRob2QsIHN1Y2ggYXNcbiAgICogY2FuY2VsbGVkIG5ldHdvcmsgcmVxdWVzdHMsIG9yIGNsZWFuaW5nIHVwIGFueSBlbGVtZW50cyBjcmVhdGVkIGluIGBzY2VuZURpZE1vdW50YC5cbiAgICovXG4gIHNjZW5lV2lsbFVubW91bnQ/KCk6IFByb21pc2U8dm9pZD4gfCB2b2lkXG5cbiAgLyoqXG4gICAqIENhbGxlZCBpbW1lZGlhdGVseSBhZnRlciBhIGNvbXBvbWVudCBpcyBtb3VudGVkLiBTZXR0aW5nIHN0YXRlIGhlcmUgd2lsbCB0cmlnZ2VyIHJlLXJlbmRlcmluZy5cbiAgICovXG4gIHNjZW5lRGlkTW91bnQ/KCk6IFByb21pc2U8dm9pZD4gfCB2b2lkXG5cbiAgLyoqXG4gICAqIENhbGxlZCBpbW1lZGlhdGVseSBhZnRlciB1cGRhdGluZyBvY2N1cnMuIE5vdCBjYWxsZWQgZm9yIHRoZSBpbml0aWFsIHJlbmRlci5cbiAgICovXG4gIHNjZW5lRGlkVXBkYXRlPyhwcmV2UHJvcHM6IFJlYWRvbmx5PFByb3BzPiwgcHJldlN0YXRlOiBSZWFkb25seTxTdGF0ZT4pOiBQcm9taXNlPHZvaWQ+IHwgdm9pZFxufVxuXG4vKipcbiAqIEJhc2UgU2NlbmUgY2xhc3MuXG4gKiBQcm92aWRlcyBgc2V0U3RhdGUoKWAgYW5kIGBmb3JjZVVwZGF0ZSgpYCwgd2hpY2ggdHJpZ2dlciByZW5kZXJpbmcuXG4gKiBAcHVibGljXG4gKlxuICogQGV4YW1wbGVcbiAqIGNsYXNzIE15Rm9vIGV4dGVuZHMgU2NyaXB0YWJsZVNjZW5lIHtcbiAqICAgYXN5bmMgcmVuZGVyKCkge1xuICogICAgIHJldHVybiA8c3BoZXJlIC8+O1xuICogICB9XG4gKiB9XG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTY3JpcHRhYmxlU2NlbmU8UHJvcHMgPSB7fSwgU3RhdGUgPSB7fT4gZXh0ZW5kcyBTY3JpcHQge1xuICAvLyBAaW50ZXJuYWxcbiAgQGluamVjdCgnRW50aXR5Q29udHJvbGxlcicpIGVudGl0eUNvbnRyb2xsZXIhOiBFbnRpdHlDb250cm9sbGVyXG5cbiAgZXZlbnRTdWJzY3JpYmVyITogRXZlbnRTdWJzY3JpYmVyXG5cbiAgLy8gQGludGVybmFsXG4gIF9kaXJ0eSA9IHRydWVcbiAgLy8gQGludGVybmFsXG4gIHByZXZQcm9wczogUHJvcHMgfCBudWxsID0gbnVsbFxuICAvLyBAaW50ZXJuYWxcbiAgcHJldlN0YXRlOiBTdGF0ZSB8IG51bGwgPSBudWxsXG4gIC8vIEBpbnRlcm5hbFxuICBfY29tcG9uZW50OiBJU2ltcGxpZmllZE5vZGUgfCBudWxsID0gbnVsbFxuXG4gIHN0YXRlOiBTdGF0ZSA9IHt9IGFzIFN0YXRlXG5cbiAgLy8gQGludGVybmFsXG4gIGNvbm5lY3Rpb25GdXR1cmUgPSBmdXR1cmU8U2NyaXB0PigpXG5cbiAgcHJvcHMhOiBQcm9wc1xuXG4gIC8qKlxuICAgKiBVcGRhdGUgc2NlbmUgc3RhdGUgYnkgY29weWluZyBwcm9wZXJ0aWVzIGZyb20gYHN0YXRlYCB0byBgdGhpcy5zdGF0ZWAuXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBzdGF0ZSBBIGhhc2ggb2Ygc3RhdGUgcHJvcGVydGllcyB0byB1cGRhdGUgd2l0aCBuZXcgdmFsdWVzXG4gICAqL1xuICBzZXRTdGF0ZShzdGF0ZTogUGFydGlhbDxTdGF0ZT4gfCAoKHN0YXRlOiBTdGF0ZSwgcHJvcHM6IFByb3BzKSA9PiBQYXJ0aWFsPFN0YXRlPikpOiB2b2lkIHtcbiAgICBsZXQgcyA9IHRoaXMuc3RhdGVcbiAgICBpZiAoIXRoaXMucHJldlN0YXRlKSB0aGlzLnByZXZTdGF0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHMpXG4gICAgT2JqZWN0LmFzc2lnbihzLCB0eXBlb2Ygc3RhdGUgPT09ICdmdW5jdGlvbicgPyBzdGF0ZShzLCB0aGlzLnByb3BzKSA6IHN0YXRlKVxuICAgIGVucXVldWVSZW5kZXIodGhpcylcbiAgfVxuXG4gIC8qKlxuICAgKiBJbW1lZGlhdGVseSBwZXJmb3JtIGEgc3luY2hyb25vdXMgcmUtcmVuZGVyIG9mIHRoZSBjb21wb25lbnQuXG4gICAqL1xuICBmb3JjZVVwZGF0ZSgpIHtcbiAgICByZW5kZXJTY3JpcHRhYmxlU2NlbmUodGhpcywgdHJ1ZSlcbiAgfVxuXG4gIC8qKlxuICAgKiBBY2NlcHRzIGBwcm9wc2AgYW5kIGBzdGF0ZWAsIGFuZCByZXR1cm5zIGEgbmV3IFZpcnR1YWwgRE9NIHRyZWUgdG8gYnVpbGQuXG4gICAqIFZpcnR1YWwgRE9NIGlzIGdlbmVyYWxseSBjb25zdHJ1Y3RlZCB2aWEgW0pTWF0oaHR0cDovL2phc29uZm9ybWF0LmNvbS93dGYtaXMtanN4KS5cbiAgICogQHBhcmFtIHtvYmplY3R9IHByb3BzICAgIFByb3BzIChlZzogSlNYIGF0dHJpYnV0ZXMpIHJlY2VpdmVkIGZyb20gcGFyZW50IGVsZW1lbnQvY29tcG9uZW50XG4gICAqIEBwYXJhbSB7b2JqZWN0fSBzdGF0ZSAgICBUaGUgY29tcG9uZW50J3MgY3VycmVudCBzdGF0ZVxuICAgKi9cbiAgYWJzdHJhY3QgYXN5bmMgcmVuZGVyKHByb3BzOiBQcm9wcywgc3RhdGU6IFN0YXRlKTogUHJvbWlzZTxJU2ltcGxpZmllZE5vZGU+XG5cbiAgLyoqXG4gICAqIEl0IG1ha2VzIGEgc3Vic2NyaXB0aW9uIHRvIHJlbW90ZSBldmVudHMsIHRob3NlIGV2ZW50cyBvY2N1ciBpbiB0aGUgY29udGV4dCBvZiB0aGUgZ2FtZSBhbmQgYXJlIHNlbnQgdGhydSB0aGUgd2lyZVxuICAgKiBwcm90b2NvbC5cbiAgICpcbiAgICogQHBhcmFtIGV2ZW50IG5hbWUgb2YgdGhlIHJlbW90ZSBldmVudCB0byBsaXN0ZW5cbiAgICogQHBhcmFtIGhhbmRsZXIgYW4gYXN5bmNcbiAgICovXG4gIHN1YnNjcmliZVRvPFQgZXh0ZW5kcyBJRXZlbnROYW1lcz4oZXZlbnQ6IFQsIGhhbmRsZXI6IChkYXRhOiBJRXZlbnRzW1RdKSA9PiB2b2lkIHwgUHJvbWlzZTx2b2lkPikge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1mbG9hdGluZy1wcm9taXNlc1xuICAgIHRoaXMuY29ubmVjdGlvbkZ1dHVyZS50aGVuKCgpID0+IHtcbiAgICAgIHRoaXMuZXZlbnRTdWJzY3JpYmVyLm9uKGV2ZW50LCB4ID0+IHtcbiAgICAgICAgY29uc3QgcmV0ID0gaGFuZGxlcih4LmRhdGEpXG4gICAgICAgIGlmIChyZXQgJiYgJ2NhdGNoJyBpbiByZXQgJiYgdHlwZW9mIHJldC5jYXRjaCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIHJldC5jYXRjaChlcnIgPT4gdGhpcy5lbWl0KCdlcnJvcicsIGVycikpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYSBzdGFuZGFyZCBldGhlcmV1bSBwcm92aWRlclxuICAgKiBQbGVhc2Ugbm90aWNlIHRoaXMgaXMgaGlnaGx5IGV4cGVyaW1lbnRhbCBhbmQgbWlnaHQgY2hhbmdlIGluIHRoZSBmdXR1cmUuXG4gICAqXG4gICAqIG1ldGhvZCB3aGl0ZWxpc3QgPSBbXG4gICAqICAgJ2V0aF9zZW5kVHJhbnNhY3Rpb24nLFxuICAgKiAgICdldGhfZ2V0VHJhbnNhY3Rpb25SZWNlaXB0JyxcbiAgICogICAnZXRoX2VzdGltYXRlR2FzJyxcbiAgICogICAnZXRoX2NhbGwnLFxuICAgKiAgICdldGhfZ2V0QmFsYW5jZScsXG4gICAqICAgJ2V0aF9nZXRTdG9yYWdlQXQnLFxuICAgKiAgICdldGhfYmxvY2tOdW1iZXInLFxuICAgKiAgICdldGhfZ2V0QmxvY2tCeU51bWJlcicsXG4gICAqICAgJ2V0aF9nYXNQcmljZScsXG4gICAqICAgJ2V0aF9wcm90b2NvbFZlcnNpb24nLFxuICAgKiAgICduZXRfdmVyc2lvbicsXG4gICAqICAgJ3dlYjNfc2hhMycsXG4gICAqICAgJ3dlYjNfY2xpZW50VmVyc2lvbicsXG4gICAqICAgJ2V0aF9nZXRUcmFuc2FjdGlvbkNvdW50J1xuICAgKiBdXG4gICAqL1xuICBhc3luYyBnZXRFdGhlcmV1bVByb3ZpZGVyKCkge1xuICAgIGNvbnN0IHsgZXhwZXJpbWVudGFsRXRoZXJldW1Db250cm9sbGVyIH0gPSBhd2FpdCB0aGlzLmxvYWRBUElzKFsnZXhwZXJpbWVudGFsRXRoZXJldW1Db250cm9sbGVyJ10pXG5cbiAgICByZXR1cm4ge1xuICAgICAgLy8gQGludGVybmFsXG4gICAgICBzZW5kKCk6IHZvaWQge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RlY2VudHJhbGFuZCBwcm92aWRlciBvbmx5IGFsbG93cyBhc3luYyBjYWxscycpXG4gICAgICB9LFxuICAgICAgc2VuZEFzeW5jKG1lc3NhZ2U6IFJQQ1NlbmRhYmxlTWVzc2FnZSwgY2FsbGJhY2s6IChlcnJvcjogRXJyb3IgfCBudWxsLCByZXN1bHQ/OiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAgICAgZXhwZXJpbWVudGFsRXRoZXJldW1Db250cm9sbGVyXG4gICAgICAgICAgLnNlbmRBc3luYyhtZXNzYWdlKVxuICAgICAgICAgIC50aGVuKCh4OiBhbnkpID0+IGNhbGxiYWNrKG51bGwsIHgpKVxuICAgICAgICAgIC5jYXRjaChjYWxsYmFjaylcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgYXN5bmMgc3lzdGVtRGlkRW5hYmxlKCkge1xuICAgIHRoaXMucHJvcHMgPSAoYXdhaXQgdGhpcy5lbnRpdHlDb250cm9sbGVyLmdldE93bkF0dHJpYnV0ZXMoKSkgYXMgUHJvcHNcblxuICAgIC8vIHdlIGNyZWF0ZSBhbiBldmVudCBzdWJzY3JpYmVyXG4gICAgdGhpcy5ldmVudFN1YnNjcmliZXIgPSBuZXcgRXZlbnRTdWJzY3JpYmVyKHRoaXMuZW50aXR5Q29udHJvbGxlcilcblxuICAgIHRoaXMub24oJ1NJR0tJTEwnLCAoKSA9PiB7XG4gICAgICBpZiAodGhpcy5zY2VuZVdpbGxVbm1vdW50KSB7XG4gICAgICAgIHRoaXMuc2NlbmVXaWxsVW5tb3VudCgpXG4gICAgICB9XG4gICAgfSlcblxuICAgIHRoaXMuc3Vic2NyaWJlVG8oJ3NldEF0dHJpYnV0ZXMnLCBuZXdQcm9wcyA9PiB7XG4gICAgICB0aGlzLnByZXZQcm9wcyA9IHRoaXMucHJvcHNcbiAgICAgIHRoaXMucHJvcHMgPSBuZXdQcm9wcyBhcyBQcm9wc1xuICAgICAgZW5xdWV1ZVJlbmRlcih0aGlzKVxuICAgIH0pXG5cbiAgICB0aGlzLmNvbm5lY3Rpb25GdXR1cmUucmVzb2x2ZSh0aGlzKVxuXG4gICAgcmVuZGVyU2NyaXB0YWJsZVNjZW5lKHRoaXMsIHRydWUpXG5cbiAgICBpZiAodGhpcy5zY2VuZURpZE1vdW50KSB7XG4gICAgICBhd2FpdCB0aGlzLnNjZW5lRGlkTW91bnQoKVxuICAgIH1cbiAgfVxufVxuIl19